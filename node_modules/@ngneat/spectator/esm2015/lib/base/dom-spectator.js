import { ChangeDetectorRef, DebugElement, ElementRef } from '@angular/core';
import { Observable } from 'rxjs';
import { tick } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { DOMSelector } from '../dom-selectors';
import { isString } from '../types';
import { getChildren, setProps } from '../internals/query';
import { patchElementFocus } from '../internals/element-focus';
import { createMouseEvent } from '../event-creators';
import { dispatchFakeEvent, dispatchKeyboardEvent, dispatchMouseEvent, dispatchTouchEvent } from '../dispatch-events';
import { typeInElement } from '../type-in-element';
import { selectOption } from '../select-option';
import { BaseSpectator } from './base-spectator';
const KEY_UP = 'keyup';
/**
 * @internal
 */
export class DomSpectator extends BaseSpectator {
    constructor(fixture, debugElement, instance, element) {
        super();
        this.fixture = fixture;
        this.debugElement = debugElement;
        this.instance = instance;
        this.element = element;
    }
    inject(token) {
        return super.inject(token);
    }
    detectChanges() {
        this.fixture.detectChanges();
    }
    query(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return document.querySelector(directiveOrSelector);
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document)[0] || null;
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options)[0] || null;
    }
    queryAll(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document);
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options);
    }
    queryLast(directiveOrSelector, options) {
        let result = [];
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                result = Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                result = directiveOrSelector.execute(document);
            }
        }
        else {
            result = getChildren(this.debugElement)(directiveOrSelector, options);
        }
        if (result && result.length) {
            return result[result.length - 1];
        }
        return null;
    }
    setInput(input, value) {
        setProps(this.instance, input, value, false);
        this.debugElement.injector.get(ChangeDetectorRef).detectChanges();
    }
    output(output) {
        const observable = this.instance[output];
        if (!(observable instanceof Observable)) {
            throw new Error(`${output} is not an @Output`);
        }
        return observable;
    }
    tick(millis) {
        tick(millis);
        this.detectChanges();
    }
    click(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot click: ${selector} is not a HTMLElement`);
        }
        element.click();
        this.detectChanges();
    }
    blur(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot blur: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.blur();
        this.detectChanges();
    }
    focus(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot focus: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.focus();
        this.detectChanges();
    }
    dispatchMouseEvent(selector = this.element, type, x = 0, y = 0, event = createMouseEvent(type, x, y)) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch mouse event: ${selector} is not a node`);
        }
        const dispatchedEvent = dispatchMouseEvent(element, type, x, y, event);
        this.detectChanges();
        return dispatchedEvent;
    }
    dispatchKeyboardEvent(selector = this.element, type, keyOrKeyCode, target) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch keyboard event: ${selector} is not a node`);
        }
        const event = dispatchKeyboardEvent(element, type, keyOrKeyCode, target);
        this.detectChanges();
        return event;
    }
    dispatchFakeEvent(selector = this.element, type, canBubble) {
        const event = dispatchFakeEvent(this.getNativeElement(selector), type, canBubble);
        this.detectChanges();
        return event;
    }
    triggerEventHandler(directiveOrSelector, eventName, eventObj, options) {
        const triggerDebugElement = this.getTriggerDebugElement(directiveOrSelector, options);
        if (!triggerDebugElement) {
            /* eslint-disable no-console */
            console.error(`${directiveOrSelector} does not exists`);
            return;
        }
        triggerDebugElement.triggerEventHandler(eventName, eventObj);
        this.detectChanges();
    }
    get keyboard() {
        return {
            pressKey: (key, selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, key);
            },
            pressEscape: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Escape', keyCode: 27 });
            },
            pressEnter: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Enter', keyCode: 13 });
            },
            pressTab: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Tab', keyCode: 9 });
            },
            pressBackspace: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Backspace', keyCode: 8 });
            },
        };
    }
    get mouse() {
        return {
            contextmenu: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'contextmenu');
            },
            dblclick: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'dblclick');
            },
        };
    }
    dispatchTouchEvent(selector = this.element, type, x = 0, y = 0) {
        dispatchTouchEvent(this.getNativeElement(selector), type, x, y);
        this.detectChanges();
    }
    typeInElement(value, selector = this.element) {
        typeInElement(value, this.getNativeElement(selector));
        this.detectChanges();
    }
    selectOption(selector = this.element, options, config = { emitEvents: true }) {
        if (!selector) {
            throw new Error(`Cannot find select: ${selector}`);
        }
        selectOption(options, this.getNativeElement(selector), config);
        this.detectChanges();
    }
    getNativeElement(selector) {
        let element;
        // Support global objects window and document
        if (selector === window || selector === document) {
            return selector;
        }
        if (isString(selector)) {
            const exists = this.debugElement.query(By.css(selector));
            if (exists) {
                element = exists.nativeElement;
            }
            else {
                /* eslint-disable no-console */
                console.error(`${selector} does not exists`);
            }
        }
        else if (selector instanceof DOMSelector) {
            element = selector.execute(document)[0] || null;
        }
        else {
            if (selector instanceof DebugElement || selector instanceof ElementRef) {
                element = selector.nativeElement;
            }
            else {
                element = selector;
            }
        }
        return element;
    }
    getTriggerDebugElement(directiveOrSelector, options) {
        const debugElement = (options === null || options === void 0 ? void 0 : options.root) ? this.getRootDebugElement() : this.debugElement;
        if (isString(directiveOrSelector)) {
            return debugElement.query(By.css(directiveOrSelector));
        }
        else if (directiveOrSelector instanceof DebugElement) {
            return directiveOrSelector;
        }
        else {
            return debugElement.query(By.directive(directiveOrSelector));
        }
    }
    getRootDebugElement() {
        let element = this.debugElement;
        /**
         * This bounded loop call is required to access the debug element for
         * root dom element
         */
        while (true) {
            if (!element) {
                throw Error('Unable to find root element');
            }
            if (!element.parent) {
                // Found the root element
                return element;
            }
            element = element.parent;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLXNwZWN0YXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvbGliL2Jhc2UvZG9tLXNwZWN0YXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQW9CLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUcvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBbUcsTUFBTSxVQUFVLENBQUM7QUFFckksT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0SCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWhELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFFdkI7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLFlBQWdCLFNBQVEsYUFBYTtJQUN6RCxZQUFtQixPQUE4QixFQUFTLFlBQTBCLEVBQVksUUFBVyxF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QyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1NBQ3hEO2FBQU0sSUFBSSxtQkFBbUIsWUFBWSxZQUFZLEVBQUU7WUFDdEQsT0FBTyxtQkFBbUIsQ0FBQztTQUM1QjthQUFNO1lBQ0wsT0FBTyxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1NBQzlEO0lBQ0gsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixJQUFJLE9BQU8sR0FBb0MsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUVqRTs7O1dBR0c7UUFDSCxPQUFPLElBQUksRUFBRTtZQUNYLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ1osTUFBTSxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQzthQUM1QztZQUVELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFO2dCQUNuQix5QkFBeUI7Z0JBQ3pCLE9BQU8sT0FBTyxDQUFDO2FBQ2hCO1lBRUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7U0FDMUI7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgRGVidWdFbGVtZW50LCBFbGVtZW50UmVmLCBUeXBlLCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvbXBvbmVudEZpeHR1cmUsIHRpY2sgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQnkgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcblxuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICcuLi90b2tlbic7XG5pbXBvcnQgeyBET01TZWxlY3RvciB9IGZyb20gJy4uL2RvbS1zZWxlY3RvcnMnO1xuaW1wb3J0IHsgaXNTdHJpbmcsIFF1ZXJ5T3B0aW9ucywgUXVlcnlUeXBlLCBTcGVjdGF0b3JFbGVtZW50LCBFdmVudEVtaXR0ZXJUeXBlLCBLZXlzTWF0Y2hpbmcsIEtleWJvYXJkRXZlbnRPcHRpb25zIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU3B5T2JqZWN0IH0gZnJvbSAnLi4vbW9jayc7XG5pbXBvcnQgeyBnZXRDaGlsZHJlbiwgc2V0UHJvcHMgfSBmcm9tICcuLi9pbnRlcm5hbHMvcXVlcnknO1xuaW1wb3J0IHsgcGF0Y2hFbGVtZW50Rm9jdXMgfSBmcm9tICcuLi9pbnRlcm5hbHMvZWxlbWVudC1mb2N1cyc7XG5pbXBvcnQgeyBjcmVhdGVNb3VzZUV2ZW50IH0gZnJvbSAnLi4vZXZlbnQtY3JlYXRvcnMnO1xuaW1wb3J0IHsgZGlzcGF0Y2hGYWtlRXZlbnQsIGRpc3BhdGNoS2V5Ym9hcmRFdmVudCwgZGlzcGF0Y2hNb3VzZUV2ZW50LCBkaXNwYXRjaFRvdWNoRXZlbnQgfSBmcm9tICcuLi9kaXNwYXRjaC1ldmVudHMnO1xuaW1wb3J0IHsgdHlwZUluRWxlbWVudCB9IGZyb20gJy4uL3R5cGUtaW4tZWxlbWVudCc7XG5pbXBvcnQgeyBzZWxlY3RPcHRpb24gfSBmcm9tICcuLi9zZWxlY3Qtb3B0aW9uJztcblxuaW1wb3J0IHsgQmFzZVNwZWN0YXRvciB9IGZyb20gJy4vYmFzZS1zcGVjdGF0b3InO1xuXG5jb25zdCBLRVlfVVAgPSAna2V5dXAnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRG9tU3BlY3RhdG9yPEk+IGV4dGVuZHMgQmFzZVNwZWN0YXRvciB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBmaXh0dXJlOiBDb21wb25lbnRGaXh0dXJlPGFueT4sIHB1YmxpYyBkZWJ1Z0VsZW1lbnQ6IERlYnVnRWxlbWVudCwgcHJvdGVjdGVkIGluc3RhbmNlOiBJLCBwdWJsaWMgZWxlbWVudDogRWxlbWVudCkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdWJsaWMgaW5qZWN0PFQ+KHRva2VuOiBUb2tlbjxUPik6IFNweU9iamVjdDxUPiB7XG4gICAgcmV0dXJuIHN1cGVyLmluamVjdCh0b2tlbik7XG4gIH1cblxuICBwdWJsaWMgZGV0ZWN0Q2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLmZpeHR1cmUuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5PFIgZXh0ZW5kcyBFbGVtZW50PihzZWxlY3Rvcjogc3RyaW5nIHwgRE9NU2VsZWN0b3IsIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnk8Uj4oZGlyZWN0aXZlOiBUeXBlPFI+KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeTxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPGFueT4gfCBzdHJpbmcsIG9wdGlvbnM6IHsgcmVhZDogVG9rZW48Uj4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnk8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogUXVlcnlUeXBlLCBvcHRpb25zPzogUXVlcnlPcHRpb25zPFI+KTogUiB8IEVsZW1lbnQgfCBudWxsIHtcbiAgICBpZiAoKG9wdGlvbnMgfHwge30pLnJvb3QpIHtcbiAgICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihkaXJlY3RpdmVPclNlbGVjdG9yKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpcmVjdGl2ZU9yU2VsZWN0b3IgaW5zdGFuY2VvZiBET01TZWxlY3Rvcikge1xuICAgICAgICByZXR1cm4gZGlyZWN0aXZlT3JTZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSlbMF0gfHwgbnVsbDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZ2V0Q2hpbGRyZW48Uj4odGhpcy5kZWJ1Z0VsZW1lbnQpKGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpWzBdIHx8IG51bGw7XG4gIH1cblxuICBwdWJsaWMgcXVlcnlBbGw8UiBleHRlbmRzIEVsZW1lbnQ+KHNlbGVjdG9yOiBzdHJpbmcgfCBET01TZWxlY3Rvciwgb3B0aW9ucz86IHsgcm9vdDogYm9vbGVhbiB9KTogUltdO1xuICBwdWJsaWMgcXVlcnlBbGw8Uj4oZGlyZWN0aXZlOiBUeXBlPFI+KTogUltdO1xuICBwdWJsaWMgcXVlcnlBbGw8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxhbnk+IHwgc3RyaW5nLCBvcHRpb25zOiB7IHJlYWQ6IFRva2VuPFI+IH0pOiBSW107XG4gIHB1YmxpYyBxdWVyeUFsbDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBRdWVyeVR5cGUsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnM8Uj4pOiBSW10gfCBFbGVtZW50W10ge1xuICAgIGlmICgob3B0aW9ucyB8fCB7fSkucm9vdCkge1xuICAgICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmVPclNlbGVjdG9yLmV4ZWN1dGUoZG9jdW1lbnQgYXMgYW55KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZ2V0Q2hpbGRyZW48Uj4odGhpcy5kZWJ1Z0VsZW1lbnQpKGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5TGFzdDxSIGV4dGVuZHMgRWxlbWVudD4oc2VsZWN0b3I6IHN0cmluZyB8IERPTVNlbGVjdG9yLCBvcHRpb25zPzogeyByb290OiBib29sZWFuIH0pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5TGFzdDxSPihkaXJlY3RpdmU6IFR5cGU8Uj4pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5TGFzdDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPGFueT4gfCBzdHJpbmcsIG9wdGlvbnM6IHsgcmVhZDogVG9rZW48Uj4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnlMYXN0PFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFF1ZXJ5VHlwZSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9uczxSPik6IFIgfCBFbGVtZW50IHwgbnVsbCB7XG4gICAgbGV0IHJlc3VsdDogKFIgfCBFbGVtZW50KVtdID0gW107XG5cbiAgICBpZiAoKG9wdGlvbnMgfHwge30pLnJvb3QpIHtcbiAgICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgICByZXN1bHQgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICAgIHJlc3VsdCA9IGRpcmVjdGl2ZU9yU2VsZWN0b3IuZXhlY3V0ZShkb2N1bWVudCBhcyBhbnkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBnZXRDaGlsZHJlbjxSPih0aGlzLmRlYnVnRWxlbWVudCkoZGlyZWN0aXZlT3JTZWxlY3Rvciwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBzZXRJbnB1dDxLIGV4dGVuZHMga2V5b2YgST4oaW5wdXQ6IFBhcnRpYWw8ST4pOiB2b2lkO1xuICBwdWJsaWMgc2V0SW5wdXQ8SyBleHRlbmRzIGtleW9mIEk+KGlucHV0OiBLLCBpbnB1dFZhbHVlOiBJW0tdKTogdm9pZDtcbiAgcHVibGljIHNldElucHV0KGlucHV0OiBhbnksIHZhbHVlPzogYW55KTogdm9pZCB7XG4gICAgc2V0UHJvcHModGhpcy5pbnN0YW5jZSwgaW5wdXQsIHZhbHVlLCBmYWxzZSk7XG4gICAgdGhpcy5kZWJ1Z0VsZW1lbnQuaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmKS5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgb3V0cHV0PFQsIEsgZXh0ZW5kcyBrZXlvZiBJID0ga2V5b2YgST4ob3V0cHV0OiBLKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHRoaXMuaW5zdGFuY2Vbb3V0cHV0XTtcblxuICAgIGlmICghKG9ic2VydmFibGUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke291dHB1dH0gaXMgbm90IGFuIEBPdXRwdXRgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2JzZXJ2YWJsZSBhcyBPYnNlcnZhYmxlPFQ+O1xuICB9XG5cbiAgcHVibGljIHRpY2sobWlsbGlzPzogbnVtYmVyKTogdm9pZCB7XG4gICAgdGljayhtaWxsaXMpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGNsaWNrKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjbGljazogJHtzZWxlY3Rvcn0gaXMgbm90IGEgSFRNTEVsZW1lbnRgKTtcbiAgICB9XG5cbiAgICBlbGVtZW50LmNsaWNrKCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgYmx1cihzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgYmx1cjogJHtzZWxlY3Rvcn0gaXMgbm90IGEgSFRNTEVsZW1lbnRgKTtcbiAgICB9XG5cbiAgICBwYXRjaEVsZW1lbnRGb2N1cyhlbGVtZW50KTtcbiAgICBlbGVtZW50LmJsdXIoKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBmb2N1cyhzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZm9jdXM6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIEhUTUxFbGVtZW50YCk7XG4gICAgfVxuXG4gICAgcGF0Y2hFbGVtZW50Rm9jdXMoZWxlbWVudCk7XG4gICAgZWxlbWVudC5mb2N1cygpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGRpc3BhdGNoTW91c2VFdmVudChcbiAgICBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICB0eXBlOiBzdHJpbmcsXG4gICAgeDogbnVtYmVyID0gMCxcbiAgICB5OiBudW1iZXIgPSAwLFxuICAgIGV2ZW50OiBNb3VzZUV2ZW50ID0gY3JlYXRlTW91c2VFdmVudCh0eXBlLCB4LCB5KVxuICApOiBNb3VzZUV2ZW50IHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZGlzcGF0Y2ggbW91c2UgZXZlbnQ6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIG5vZGVgKTtcbiAgICB9XG5cbiAgICBjb25zdCBkaXNwYXRjaGVkRXZlbnQgPSBkaXNwYXRjaE1vdXNlRXZlbnQoZWxlbWVudCwgdHlwZSwgeCwgeSwgZXZlbnQpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgcmV0dXJuIGRpc3BhdGNoZWRFdmVudDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQsIHR5cGU6IHN0cmluZywga2V5Q29kZTogbnVtYmVyLCB0YXJnZXQ/OiBFbGVtZW50KTogS2V5Ym9hcmRFdmVudDtcbiAgcHVibGljIGRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCwgdHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZywgdGFyZ2V0PzogRWxlbWVudCk6IEtleWJvYXJkRXZlbnQ7XG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQsIHR5cGU6IHN0cmluZywga2V5QW5kQ29kZTogS2V5Ym9hcmRFdmVudE9wdGlvbnMsIHRhcmdldD86IEVsZW1lbnQpOiBLZXlib2FyZEV2ZW50O1xuICBwdWJsaWMgZGlzcGF0Y2hLZXlib2FyZEV2ZW50KFxuICAgIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBrZXlPcktleUNvZGU6IHN0cmluZyB8IG51bWJlciB8IEtleWJvYXJkRXZlbnRPcHRpb25zLFxuICAgIHRhcmdldD86IEVsZW1lbnRcbiAgKTogS2V5Ym9hcmRFdmVudCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgTm9kZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRpc3BhdGNoIGtleWJvYXJkIGV2ZW50OiAke3NlbGVjdG9yfSBpcyBub3QgYSBub2RlYCk7XG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnQgPSBkaXNwYXRjaEtleWJvYXJkRXZlbnQoZWxlbWVudCwgdHlwZSwga2V5T3JLZXlDb2RlLCB0YXJnZXQpO1xuXG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hGYWtlRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIHR5cGU6IHN0cmluZywgY2FuQnViYmxlPzogYm9vbGVhbik6IEV2ZW50IHtcbiAgICBjb25zdCBldmVudCA9IGRpc3BhdGNoRmFrZUV2ZW50KHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvciksIHR5cGUsIGNhbkJ1YmJsZSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBwdWJsaWMgdHJpZ2dlckV2ZW50SGFuZGxlcjxDID0gYW55LCBLIGV4dGVuZHMgS2V5c01hdGNoaW5nPEMsIEV2ZW50RW1pdHRlcjxhbnk+PiA9IGFueT4oXG4gICAgZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxDPiB8IHN0cmluZyB8IERlYnVnRWxlbWVudCxcbiAgICBldmVudE5hbWU6IEssXG4gICAgZXZlbnRPYmo6IEV2ZW50RW1pdHRlclR5cGU8Q1tLXT4sXG4gICAgb3B0aW9ucz86IHsgcm9vdDogYm9vbGVhbiB9XG4gICkge1xuICAgIGNvbnN0IHRyaWdnZXJEZWJ1Z0VsZW1lbnQgPSB0aGlzLmdldFRyaWdnZXJEZWJ1Z0VsZW1lbnQoZGlyZWN0aXZlT3JTZWxlY3Rvciwgb3B0aW9ucyk7XG4gICAgaWYgKCF0cmlnZ2VyRGVidWdFbGVtZW50KSB7XG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG4gICAgICBjb25zb2xlLmVycm9yKGAke2RpcmVjdGl2ZU9yU2VsZWN0b3J9IGRvZXMgbm90IGV4aXN0c2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyaWdnZXJEZWJ1Z0VsZW1lbnQudHJpZ2dlckV2ZW50SGFuZGxlcihldmVudE5hbWUgYXMgc3RyaW5nLCBldmVudE9iaik7XG5cbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQga2V5Ym9hcmQoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHByZXNzS2V5OiAoa2V5OiBzdHJpbmcsIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIGtleSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NFc2NhcGU6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0VzY2FwZScsIGtleUNvZGU6IDI3IH0pO1xuICAgICAgfSxcbiAgICAgIHByZXNzRW50ZXI6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0VudGVyJywga2V5Q29kZTogMTMgfSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NUYWI6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ1RhYicsIGtleUNvZGU6IDkgfSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NCYWNrc3BhY2U6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0JhY2tzcGFjZScsIGtleUNvZGU6IDggfSk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1vdXNlKCkge1xuICAgIHJldHVybiB7XG4gICAgICBjb250ZXh0bWVudTogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hNb3VzZUV2ZW50KHNlbGVjdG9yLCAnY29udGV4dG1lbnUnKTtcbiAgICAgIH0sXG4gICAgICBkYmxjbGljazogKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hNb3VzZUV2ZW50KHNlbGVjdG9yLCAnZGJsY2xpY2snKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaFRvdWNoRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIHR5cGU6IHN0cmluZywgeDogbnVtYmVyID0gMCwgeTogbnVtYmVyID0gMCk6IHZvaWQge1xuICAgIGRpc3BhdGNoVG91Y2hFdmVudCh0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpLCB0eXBlLCB4LCB5KTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyB0eXBlSW5FbGVtZW50KHZhbHVlOiBzdHJpbmcsIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgdHlwZUluRWxlbWVudCh2YWx1ZSwgdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgc2VsZWN0T3B0aW9uKFxuICAgIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgIG9wdGlvbnM6IHN0cmluZyB8IHN0cmluZ1tdIHwgSFRNTE9wdGlvbkVsZW1lbnQgfCBIVE1MT3B0aW9uRWxlbWVudFtdLFxuICAgIGNvbmZpZzogeyBlbWl0RXZlbnRzOiBib29sZWFuIH0gPSB7IGVtaXRFdmVudHM6IHRydWUgfVxuICApOiB2b2lkIHtcbiAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIHNlbGVjdDogJHtzZWxlY3Rvcn1gKTtcbiAgICB9XG4gICAgc2VsZWN0T3B0aW9uKG9wdGlvbnMsIHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvciksIGNvbmZpZyk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIGdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQpOiBIVE1MRWxlbWVudCB8IFdpbmRvdyB8IERvY3VtZW50IHtcbiAgICBsZXQgZWxlbWVudDtcblxuICAgIC8vIFN1cHBvcnQgZ2xvYmFsIG9iamVjdHMgd2luZG93IGFuZCBkb2N1bWVudFxuICAgIGlmIChzZWxlY3RvciA9PT0gd2luZG93IHx8IHNlbGVjdG9yID09PSBkb2N1bWVudCkge1xuICAgICAgcmV0dXJuIHNlbGVjdG9yIGFzIGFueTtcbiAgICB9XG5cbiAgICBpZiAoaXNTdHJpbmcoc2VsZWN0b3IpKSB7XG4gICAgICBjb25zdCBleGlzdHMgPSB0aGlzLmRlYnVnRWxlbWVudC5xdWVyeShCeS5jc3Moc2VsZWN0b3IpKTtcbiAgICAgIGlmIChleGlzdHMpIHtcbiAgICAgICAgZWxlbWVudCA9IGV4aXN0cy5uYXRpdmVFbGVtZW50O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuICAgICAgICBjb25zb2xlLmVycm9yKGAke3NlbGVjdG9yfSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHNlbGVjdG9yIGluc3RhbmNlb2YgRE9NU2VsZWN0b3IpIHtcbiAgICAgIGVsZW1lbnQgPSBzZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSlbMF0gfHwgbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNlbGVjdG9yIGluc3RhbmNlb2YgRGVidWdFbGVtZW50IHx8IHNlbGVjdG9yIGluc3RhbmNlb2YgRWxlbWVudFJlZikge1xuICAgICAgICBlbGVtZW50ID0gc2VsZWN0b3IubmF0aXZlRWxlbWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQgPSBzZWxlY3RvcjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VHJpZ2dlckRlYnVnRWxlbWVudChcbiAgICBkaXJlY3RpdmVPclNlbGVjdG9yOiBzdHJpbmcgfCBEZWJ1Z0VsZW1lbnQgfCBUeXBlPHVua25vd24+LFxuICAgIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfVxuICApOiBEZWJ1Z0VsZW1lbnQgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGRlYnVnRWxlbWVudCA9IG9wdGlvbnM/LnJvb3QgPyB0aGlzLmdldFJvb3REZWJ1Z0VsZW1lbnQoKSA6IHRoaXMuZGVidWdFbGVtZW50O1xuXG4gICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICByZXR1cm4gZGVidWdFbGVtZW50LnF1ZXJ5KEJ5LmNzcyhkaXJlY3RpdmVPclNlbGVjdG9yKSk7XG4gICAgfSBlbHNlIGlmIChkaXJlY3RpdmVPclNlbGVjdG9yIGluc3RhbmNlb2YgRGVidWdFbGVtZW50KSB7XG4gICAgICByZXR1cm4gZGlyZWN0aXZlT3JTZWxlY3RvcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRlYnVnRWxlbWVudC5xdWVyeShCeS5kaXJlY3RpdmUoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Um9vdERlYnVnRWxlbWVudCgpOiBEZWJ1Z0VsZW1lbnQge1xuICAgIGxldCBlbGVtZW50OiBEZWJ1Z0VsZW1lbnQgfCBudWxsIHwgdW5kZWZpbmVkID0gdGhpcy5kZWJ1Z0VsZW1lbnQ7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGJvdW5kZWQgbG9vcCBjYWxsIGlzIHJlcXVpcmVkIHRvIGFjY2VzcyB0aGUgZGVidWcgZWxlbWVudCBmb3JcbiAgICAgKiByb290IGRvbSBlbGVtZW50XG4gICAgICovXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGlmICghZWxlbWVudCkge1xuICAgICAgICB0aHJvdyBFcnJvcignVW5hYmxlIHRvIGZpbmQgcm9vdCBlbGVtZW50Jyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghZWxlbWVudC5wYXJlbnQpIHtcbiAgICAgICAgLy8gRm91bmQgdGhlIHJvb3QgZWxlbWVudFxuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICAgIH1cblxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50O1xuICAgIH1cbiAgfVxufVxuIl19